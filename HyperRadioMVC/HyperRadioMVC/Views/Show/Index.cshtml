@model HyperRadioMVC.ViewModels.CreateShowVM

<link rel="stylesheet" href="~/css/pitch.css" asp-append-version="true" />


@{
    ViewBag.Title = "Pitch a Track";
    Layout = "_Layout";
}


<div class="form">
    <h1 class="form-title">Create a Show</h1>

    <form id="multi-step-form" class="form-body" action="https://hyper-radio-api-ezgpemf9d5g2cuc0.norwayeast-01.azurewebsites.net/api/shows" method="post">

        <div class="form-step active">
        <div class="form-field">
            <label asp-for="Name" class="form-label">Show Name</label>
            <input type="text" asp-for="Name" class="form-control" required />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>

        <div class="form-field">
            <label asp-for="Description" class="form-label">Show Description</label>
            <input type="text" asp-for="Description" class="form-control" required />
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>

            <div class="form-nav">
                <button type="button" class="form-btn next-btn">Next →</button>
            </div>

            
        </div>


        <div class="form-step">
            <div class="form-field">
                <label class="form-label">Tracks (in order)</label>
                <div id="track-select-container">
                    <div class="track-select">
                        <select name="TrackIds" class="form-select track-dropdown" required></select>
                    </div>
                </div>

                <button type="button" id="add-track-btn" class="form-btn" style="margin-top: 0.5rem;">
                    + Add another track
                </button>
                
                <div class="form-nav">
                <button type="button" class="form-btn back-btn">← Back</button>
                    <button type="submit" class="form-btn submit-btn" style="margin-top: 1rem;">Create Show</button>
                </div>
            </div>

        </div>
    </form>
</div>




<script>
document.addEventListener("DOMContentLoaded", async () => {
    const steps = document.querySelectorAll(".form-step");
    const nextBtns = document.querySelectorAll(".next-btn");
    const backBtns = document.querySelectorAll(".back-btn");
    const container = document.getElementById("track-select-container");
    const addBtn = document.getElementById("add-track-btn");
    const apiUrl = "http://localhost:5054/api/Tracks"; 

    let tracks = [];

    // ===== Step Navigation =====
    let currentStep = 0;
    function showStep(index) {
        steps.forEach((step, i) => step.classList.toggle("active", i === index));
    }

    nextBtns.forEach(btn => btn.addEventListener("click", () => {
        currentStep = Math.min(currentStep + 1, steps.length - 1);
        showStep(currentStep);
    }));

    backBtns.forEach(btn => btn.addEventListener("click", () => {
        currentStep = Math.max(currentStep - 1, 0);
        showStep(currentStep);
    }));

    // ===== Fetch Tracks =====
    async function fetchTracks() {
        try {
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`Failed to fetch: ${res.status}`);
            tracks = await res.json();
            console.log("✅ Loaded tracks:", tracks);
        } catch (err) {
            console.error("❌ Error fetching tracks:", err);
            alert("Could not load tracks from the server.");
        }
    }

    // ===== Populate a Dropdown =====
    function populateDropdown(select) {
        select.innerHTML = '<option value="">Select a track</option>';
        tracks.forEach(track => {
            const opt = document.createElement("option");
            opt.value = track.id;
            opt.textContent = `${track.title} (${track.genre || "Unknown"})`;
            select.appendChild(opt);
        });
    }

    // ===== Add Track Dropdown =====
    function addTrackDropdown() {
        const wrapper = document.createElement("div");
        wrapper.className = "track-select flex items-center space-x-2";

        const select = document.createElement("select");
        select.name = "TrackIds";
        select.className = "form-select track-dropdown";
        select.required = true;
        populateDropdown(select);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";
        removeBtn.className = "form-btn back-btn";
        removeBtn.addEventListener("click", () => wrapper.remove());

        wrapper.appendChild(select);
        wrapper.appendChild(removeBtn);
        container.appendChild(wrapper);
    }

    // ===== Initialize =====
    await fetchTracks();

    const firstDropdown = document.querySelector(".track-dropdown");
    if (firstDropdown) populateDropdown(firstDropdown);

    addBtn.addEventListener("click", addTrackDropdown);
});
</script>