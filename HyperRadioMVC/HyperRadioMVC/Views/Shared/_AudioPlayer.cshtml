@* Persistent Audio Player *@
<link rel="stylesheet" href="~/css/player.css" asp-append-version="true"/>

<footer id="audio-player">
    <audio id="audio" preload="none"></audio>

    <div class="player-section now-playing">
        <span class="label">Now Playing:</span>
        <div>
            <strong id="song-name">Sample Show</strong>
            <p id="artist-name">Show Description</p>
        </div>
    </div>

    <div class="player-section player-controls">
        <button id="play-btn" class="control-btn">
            <img src="~/play.svg" alt="Play" class="icon"/>
        </button>
        <button id="pause-btn" class="control-btn hidden">
            <img src="~/pause.svg" alt="Pause" class="icon"/>
        </button>
    </div>

    <div class="player-section player-volume">
        <input id="volume" type="range" min="0" max="1" step="0.05" value="1"/>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script>
(function() {
    let hls;
    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("play-btn");
    const pauseBtn = document.getElementById("pause-btn");
    const volumeSlider = document.getElementById("volume");

    // Initialize HLS
    function initHLS(url) {
        if (hls) hls.destroy();
        hls = null;

        if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(audio);
            hls.on(Hls.Events.MANIFEST_PARSED, () => audio.play().catch(()=>{}));
            hls.on(Hls.Events.ERROR, (event, data) => console.error("HLS error:", data));
        } else if (audio.canPlayType("application/vnd.apple.mpegurl")) {
            audio.src = url;
            audio.play().catch(()=>{});
        }
    }

    // Play/pause event listeners (only attach once)
    if (!playBtn.dataset.listener) {
        playBtn.addEventListener("click", async () => {
            if (hls) hls.startLoad();
            await audio.play().catch(()=>{});
        });
        pauseBtn.addEventListener("click", () => {
            if (hls) hls.stopLoad();
            audio.pause();
        });

        audio.addEventListener("play", () => {
            playBtn.classList.add("hidden");
            pauseBtn.classList.remove("hidden");
        });
        audio.addEventListener("pause", () => {
            pauseBtn.classList.add("hidden");
            playBtn.classList.remove("hidden");
        });

        volumeSlider.addEventListener("input", e => audio.volume = e.target.value);

        playBtn.dataset.listener = "true"; // mark as initialized
    }

    // Unlock autoplay on first interaction
    const unlock = () => audio.play().catch(()=>{});
    document.addEventListener("click", unlock, { once: true });
    document.addEventListener("keydown", unlock, { once: true });

    // Global function to play any show
    window.playShow = (showId, name, description) => {
        document.getElementById("song-name").innerText = name;
        document.getElementById("artist-name").innerText = description;

        const streamUrl = `https://hyper-radio-streamer-gqeaffc3cucfhxb8.norwayeast-01.azurewebsites.net/api/stream/live.m3u8/${showId}`;
        initHLS(streamUrl);
        audio.play().catch(()=>{});
    };

    // Initialize default stream
    initHLS("https://hyper-radio-streamer-gqeaffc3cucfhxb8.norwayeast-01.azurewebsites.net/api/stream/live.m3u8/2");
})();
</script>